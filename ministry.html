<!DOCTYPE html>
<html lang="en">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"
        integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
        integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
        crossorigin="anonymous"></script>
<head>
    <meta charset="UTF-8">
    <title><Ministry></title>
    <script src="show.js"></script>
</head>
<body>
<div style="background-color: azure">
    <h1 style="text-align: center">Ministry</h1>
    <div style="text-align: right; margin-right: 50px " id="result1"></div>
</div>
<div style="background-color: #eaeaea;height: 50px">
    <ul class="nav justify-content-center">
        <li class="nav-item">
            <a class="nav-link" href="#" onclick="gradesForm()">Update Grades</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#"></a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" onclick="studentForm()">Update Status</a>
        </li>
    </ul>
</div>
<br>
<div>
    <span style="font-size: 17px;color: red ; padding-left: 50px" id="success"></span><br><br>
    <div id="form"></div>
</div>
<br><br>
</body>




<script type="text/javascript">
    $(document).ready(function () {
        let avatar = window.sessionStorage.getItem('AVATAR_KEY');
        viewAccount(avatar);
        let name = window.sessionStorage.getItem('NAME_KEY')
        document.getElementById("name").innerHTML = name;
        let roles = JSON.parse(window.sessionStorage.getItem('ROLE_KEY'));
        if (roles === null) {
            window.location.href = 'login.html';
        }
        for (let i = 0; i < roles.length; i++) {
            if (roles[i].authority !== 'MINISTRY') {
                window.location.href = 'login.html';
                return
            }
        }
    })


    function gradesForm() {
        document.getElementById("success").innerHTML = "";
        event.preventDefault();
        document.getElementById("form").innerHTML =
            `
<div style="width: 60%;padding-left: 30px">
    <form>
        <div class="mb-3">
            <label for="classes" class="form-label">Class:</label>
            <select class="form-select" aria-label="Default select example"
                                    onchange="showStudentByClassesId()" id="classes">
            </select>
        </div>
        <div class="mb-3">
            <label for="users" class="form-label">Student:</label>
            <select class="form-select" oninput="showGrade()"
                    aria-label="Default select example" id="users"></select>
        </div>
        <div class="mb-3">
            <label for="subject" class="form-label">Subject:</label>
            <select class="form-select" oninput="showGrade()"
                    aria-label="Default select example" id="subject"></select>
        </div>
        <div class="mb-3">
            <label for="exam" class="form-label">Module:</label>
            <select class="form-select" oninput="showGrade()"
                    aria-label="Default select example" id="exam">
                <option value="Module1">Module1</option>
                <option value="Module2">Module2</option>
                <option value="Module3">Module3</option>
                <option value="Module4">Module4</option>
                <option value="Module5">Module5</option>
                <option value="Module6">Module6</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="theory" class="form-label">Theory:</label>
            <input type="number" class="form-control" oninput="averageCalculate()" id="theory">
        </div>
        <div class="mb-3">
            <label for="practice" class="form-label">Practice:</label>
            <input type="number" class="form-control" oninput="averageCalculate()" id="practice">
        </div>
        <div class="mb-3">
            <label for="average" class="form-label">Average:</label>
            <input type="number" class="form-control" id="average">
        </div>
        <input type="number" id="id" hidden >
        <button type="submit" class="btn btn-primary" onclick="saveGrades()">Save Grade</button>
    </form>
</div>
            `
        showAllClasses()
        showAllSubject()
    }

    function showGrade() {
        let users_id = $('#users').val();
        let subject_id = $('#subject').val();
        let exam = $('#exam').val();

        let message = {message: "not grade!"}
        $.ajax({
            url: 'http://localhost:8080/grade/findByUsersIdAndExamAndSubject/' + users_id + '/' + subject_id + '?exam=' + exam,
            type: "GET",
            success: function (data) {
                if (JSON.stringify(data) === JSON.stringify(message)) {
                    $('#theory').val('');
                    $('#practice').val('');
                    $('#average').val('');
                    $('#id').val('');
                } else {
                    $('#theory').val(data.theory);
                    $('#practice').val(data.practice);
                    $('#average').val(data.average);
                    $('#id').val(data.id);
                }
            }
        })
    }

    function averageCalculate() {
        let theory = parseInt($('#theory').val());
        let practice = parseInt($('#practice').val());
        let average = (theory + practice) / 2
        console.log('------'+average)
        $('#average').val(average)
    }

    function saveGrades() {
        let exam = $('#exam').val();
        let theory = $('#theory').val();
        let practice = $('#practice').val();
        let average = $('#average').val();
        let subject_id = $('#subject').val();
        let users_id = $('#users').val();

        let grade = {
            exam: exam,
            theory: theory,
            practice: practice,
            average: average,
            subject_id: subject_id,
            users_id: users_id
        }

        let id = $('#id').val();
        if (id === '') {
            id = 0
        }
        let success = {message: "Create success!"}
        $.ajax({
            url: 'http://localhost:8080/grade/create?id=' + id,
            method: 'POST',
            data: JSON.stringify(grade),
            contentType: 'application/json; charset=utf8',
            success: function (data) {
                if (JSON.stringify(data) === JSON.stringify(success)) {
                    gradesForm()
                    document.getElementById("success").innerHTML = "Lưu điểm  thành công";
                }
            }

        })
    }


    function studentForm() {
        event.preventDefault();
        document.getElementById("success").innerHTML = "";
        document.getElementById("form").innerHTML =
            `
 <div style="width: 60%;padding-left: 30px">
    <form>
        <div class="mb-3">
            <label for="classes" class="form-label">Class:</label>
            <select class="form-select" aria-label="Default select example"
                                    onchange="showStudentByClassesId()" id="classes">
            </select>
        </div>
        <div class="mb-3">
            <label for="users" class="form-label">Student:</label>
            <select class="form-select" aria-label="Default select example" id="users"></select>
        </div>
        <div class="mb-3">
            <label for="subject" class="form-label">Status:</label>
            <select class="form-select" aria-label="Default select example" id="status">
                <option >--Chọn--</option>
                    <option value="Đang học">Đang học</option>
                    <option value="Thôi học">Thôi học</option>
                    <option value="Đình chỉ">Đình chỉ</option>
                    <option value="Chờ chuyển lớp">Chờ chuyển lớp</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary" onclick="updateStudentStatus()">Update Status</button>
    </form>
</div>
`
        showAllClasses()
    }

    function updateStudentStatus() {
        let response = {message: "update success!"}
        let usersID = $('#users').val();
        let status = $('#status').val();
        $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            type: 'PUT',
            url: 'http://localhost:8080/user/updateStatus/' + usersID + '?status=' + status,
            success: function (data) {
                if (JSON.stringify(data) === JSON.stringify(response)) {
                    studentForm()
                    document.getElementById("success").innerText = "Cập nhật trạng thái thành công";
                }
            }
        });
    }


    function logOut() {
        event.preventDefault()
        logOutConfirm()
    }
</script>
</html>