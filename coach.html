<!DOCTYPE html>
<html lang="en">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-------------PHÂN TRANG ------------->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.css" rel="stylesheet"/>
<!-------------/PHÂN TRANG ------------->

<head>
    <meta charset="UTF-8">
    <title>Coach</title>
    <script src="show.js"></script>
</head>
<body>
<h1>Coach</h1>


<div style="text-align: right; margin-right: 50px ">
    <div style="margin-right: -17px">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTGkvHnw-e8xkeN27LPJn5JJvw4XbIgOM8OEw&usqp=CAU"
             alt="" width="100" height="100"><br>
    </div>
    <div>
        <span id="name" style="font-size: 20px"></span>
    </div>
    <div>
        <a href="" onclick="logOut()">Log Out</a>
    </div>
</div>

<div><span id='success' style=' color: red;font-size: 20px'></span></div>
<div id="result"></div>
<div id="result2"></div>



</body>
<script type="text/javascript">
    $(document).ready(function () {
        let name = window.sessionStorage.getItem('NAME_KEY')
        document.getElementById("name").innerHTML = name;

        let roles = JSON.parse(window.sessionStorage.getItem('ROLE_KEY'));
        if (roles === null) {
            window.location.href = 'login.html';
        }
        for (let i = 0; i < roles.length; i++) {
            if (roles[i].authority !== 'COACH') {
                window.location.href = 'login.html';
                return
            }
        }
        showListClasses()
    })

    function showListClasses(){
        let id = window.sessionStorage.getItem('ID_KEY');
        $.ajax({
            url: 'http://localhost:8080/classes/findAllByUser/' + id,
            type: "GET",
            success: function (data) {
                let result =
                    "<table width='60%' border='1px'>\n" +
                    "        <thead>\n" +
                    "        <tr>\n" +
                    "            <th>STT</th>\n" +
                    "            <th>Tên lớp</th>\n" +
                    "            <th>Sĩ số</th>\n" +
                    "            <th>Chi tiết lớp</th>\n" +
                    "            <th>Viết nhật ký</th>\n" +
                    "        </tr>\n" +
                    "        </thead>\n" +
                    "        <tbody>";

                for (let i = 0; i < data.length; i++) {
                    let count = 0;
                    let users = data[i].users
                    for (let j = 0; j < users.length; j++) {
                        for (let k = 0; k < users[j].roles.length; k++) {
                            if (users[j].roles[k].name === 'STUDENT') {
                                count += 1;
                            }
                        }
                    }
                    result += ` <tr>
                <td>${i + 1}</td>
                <td>${data[i].name}</td>
                <td>${count}</td>
                <td><a href="" onclick="showListStudentByClassId(${data[i].id})">Chi tiết</a></td>
                <td><button onclick="showDiaryForm(${data[i].id},'classDiary')">Viết nhật ký cho lớp ${data[i].name}</button></td>
            </tr>`
                }
                result += "  </tbody>\n" +
                    "    </table>" +
                    "<br> <div id='resultDiaryForm'></div>"

                document.getElementById("result").innerHTML = result;
            }
        })
    }


    function showDiaryForm(id,typeDiary) {
        event.preventDefault()
        document.getElementById("success").innerHTML ="";
        if (typeDiary==='classDiary'){
            document.getElementById("resultDiaryForm").innerHTML =
                `<div>
                    <form action="">
                        <textarea placeholder="Nhập nội dung nhật ký " style="width: 400px;height: 200px" id="content"></textarea><br>
                        <button onclick="addNewDiary(${id},'classDiary')">Lưu nhật ký</button>
                        <button onclick="reloadPage()" >Huỷ</button>
                    </form>
                            </div>`
        }else {
            document.getElementById("resultStudentDiaryForm").innerHTML =
                `<div>
                    <form action="">

                        <textarea placeholder="Nhập nội dung nhật ký " style="width: 400px;height: 200px" id="content"></textarea><br>
                        <button onclick="addNewDiary(${id},'studentDiary')">Lưu nhật ký</button>
                        <button onclick="showStudentDetail(${id})">Huỷ</button>
                    </form>
                            </div>`
        }

    }


    function addNewDiary(id,typeDiary) {
        event.preventDefault();
        let content = $('#content').val();
        let date = new Date();
        let coachName = window.sessionStorage.getItem('NAME_KEY');
        let diary={};

        if (typeDiary==='classDiary'){
            diary = {
                content:content,
                date:date,
                coachName:coachName,
                classesId:id
            }
        }else {
            diary = {
                content:content,
                date:date,
                coachName:coachName,
                usersId:id
            }
        }

        let success = {message: "Create success!"}
        $.ajax({
            contentType: 'application/json; charset=utf8',
            url: 'http://localhost:8080/diary/create',
            method: 'POST',
            data: JSON.stringify(diary),
            success: function (data) {
                if (JSON.stringify(data) === JSON.stringify(success)) {
                    if (typeDiary==='classDiary'){
                        showListClasses()
                        document.getElementById("success").innerHTML = "Đã lưu vào nhật ký của ngày hôm nay!";
                    }else {
                        showStudentDetail();
                        document.getElementById("resultStudentDiaryForm").innerHTML =""
                        document.getElementById("success").innerHTML = "Đã lưu vào nhật ký của ngày hôm nay!";
                    }

                }
            }
        })

    }


    function showListStudentByClassId(id) {
        event.preventDefault()
        window.sessionStorage.setItem('CLASSES_ID', id);
        let url = ('http://localhost:8080/user/findAllStudentByClassesId/' + id);
        $.ajax({
            url: url,
            type: "GET",
            success: function (data) {
                let size = data.length;
                showPageListStudent(url, size)
            }
        })
    }


    function showPageListStudent(url, size) {
        $(function () {
            let container = $('#result2');
            container.pagination({
                dataSource: url,
                locator: 'itemts',
                totalNumber: size,
                pageSize: 3,
                callback: function (response, pagination) {
                    let result =
                        '<div><a href="" onclick="reloadPage()">Quay lại danh sách lớp</a></div> <br>' +
                        '<div>\n' +
                        '    <label for="status">Chọn trạng thái hiển thị:</label>\n' +
                        '    <select onchange="showPageListStudentByStatus(window.sessionStorage.getItem(`CLASSES_ID`))" id="status">\n' +
                        '        <option>----</option>\n' +
                        '        <option value="all">Tất cả</option>\n' +
                        '        <option value="Đang học">Đang học</option>\n' +
                        '        <option value="Đình chỉ">Đình chỉ</option>\n' +
                        '        <option value="Chờ chuyển lớp">Chờ chuyển lớp</option>\n' +
                        '        <option value="Thôi học">Thôi học</option>\n' +
                        '    </select>\n' +
                        '</div>' +
                        ' <br>' +
                        '<table width="50%" border="1px">\n' +
                        '        <thead>\n' +
                        '        <tr>\n' +
                        '            <th>STT</th>\n' +
                        '            <th>Ảnh</th>\n' +
                        '            <th>Họ tên</th>\n' +
                        '        </tr>\n' +
                        '        </thead>\n' +
                        '        <tbody>';

                    let pageStart = (pagination.pageNumber - 1) * pagination.pageSize;
                    let pageEnd = pageStart + pagination.pageSize;
                    let pageItems = response.slice(pageStart, pageEnd);
                    $.each(pageItems, function (index, item) {
                        let indexs = index + 1;
                        result +=
                            `<tr>
                                <td>${indexs}</td>
                                <td><img src="${item.avatar}" alt="" width="120" height="120"></td>
                                <td><a href="" onclick="showStudentDetail(${item.id})">${item.fullName}</a></td>
                            </tr>`
                    })
                    result += "  </tbody>\n" +
                        "    </table>"
                    container.prev().html(result);

                }
            })
        })
    }


    function showStudentDetail(id){
        event.preventDefault()
        $.ajax({
            url: 'http://localhost:8080/user/findById/'+id,
            type: "GET",
            success: function (data) {
                document.getElementById("result").innerHTML=
                `
<div>
<a href="" onclick="showListStudentByClassId(${window.sessionStorage.getItem('CLASSES_ID')})">Quay lại danh sách học sinh</a>
<br>
    <fieldset style="width: 50%">
        <legend>Information</legend>
        <table>
            <tr>
                <td>
                 <img src="https://encrypted-tbn0.gstatic.com/
            images?q=tbn:ANd9GcSUaYtKWENSLyHB22aNDcKzIQagFGxtQ20FPA&usqp=CAU"
                     alt="" width="400" height="300">
                </td>
            </tr>
            <tr>
                <td>${data.fullName}</td>
            </tr>
            <tr>
                <td>${data.email}</td>
            </tr>
            <tr>
                <td>${data.phoneNumber}</td>
            </tr>
            <tr>
                <td>${data.address}</td>
            </tr>
            <tr>
                <td>${data.status}</td>
            </tr>
            <tr>
                <td><a href="" onclick="showDiaryForm(${data.id},'studentDiary')">Viết nhật ký cho ${data.fullName}</a></td>
            </tr>
        </table>
        <div id='resultStudentDiaryForm'></div>
    </fieldset>
</div>
--------------------------------------------

                `

            }
        })
    }


    function showPageListStudentByStatus(id) {
        let status = $('#status').val()
        let url = ('http://localhost:8080/user/findAllStudentByClassesId/' + id + '?status=' + status);
        $.ajax({
            url: url,
            type: "GET",
            success: function (data) {
                let size = data.length;
                showPageListStudent(url, size)
            }
        })
    }


    function reloadPage() {
        location.reload();
    }


    function logOut() {
        event.preventDefault()
        logOutConfirm()
    }</script>
</html>