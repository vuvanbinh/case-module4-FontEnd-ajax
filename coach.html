<!DOCTYPE html>
<html lang="en">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-------------PHÂN TRANG ------------->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.css" rel="stylesheet"/>
<!-------------/PHÂN TRANG ------------->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"
        integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
        integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
        crossorigin="anonymous"></script>

<head>
    <meta charset="UTF-8">
    <title>Coach</title>
    <script src="show.js"></script>
</head>
<body>
<div style="background-color: azure">
    <h1 style="text-align: center">Coach</h1>
    <div style="text-align: right; margin-right: 50px " id="result1"></div>
</div>
<br>

<div style="padding-left: 30px">
    <div><span id='success' style=' color: red;font-size: 20px'></span></div>
    <div id="result"></div>
    <div id="result2"></div>
</div>
<br><br>
</body>
<script type="text/javascript">

    $(document).ready(function () {
        let avatar = window.sessionStorage.getItem('AVATAR_KEY');
        viewAccount(avatar);

        let name = window.sessionStorage.getItem('NAME_KEY')
        document.getElementById("name").innerHTML = name;

        let roles = JSON.parse(window.sessionStorage.getItem('ROLE_KEY'));
        if (roles === null) {
            window.location.href = 'login.html';
        }
        for (let i = 0; i < roles.length; i++) {
            if (roles[i].authority !== 'COACH') {
                window.location.href = 'login.html';
                return
            }
        }
        showListClasses()
    })

    function showListClasses() {
        let id = window.sessionStorage.getItem('ID_KEY');
        $.ajax({
            url: 'http://localhost:8080/classes/findAllByUser/' + id,
            type: "GET",
            success: function (data) {
                let result =
                    `<table style="width: 95%" class="table">
                        <thead>
                        <tr>
                            <th scope="col">STT</th>
                            <th scope="col">Class name</th>
                            <th scope="col">SiSo</th>
                            <th scope="col">Handle</th>
                        </tr>
                        </thead>
                        <tbody>`;
                let studentTotal = 0;
                for (let i = 0; i < data.length; i++) {
                    let count = 0;
                    let users = data[i].users
                    for (let j = 0; j < users.length; j++) {
                        for (let k = 0; k < users[j].roles.length; k++) {
                            if (users[j].roles[k].name === 'STUDENT') {
                                count += 1;
                            }
                        }
                    }
                    result +=
                        ` <tr>
                <th scope="row">${i + 1}</th>
                <td><a href="" onclick="showListStudentByClassId(${data[i].id})">${data[i].name}</a></td>
                <td>${count}</td>
                <td><button onclick="showDiaryForm(${data[i].id},'classDiary')">Viết nhật ký cho lớp ${data[i].name}</button></td>
            </tr>`
                    studentTotal += count;
                }
                result += "  </tbody>\n" +
                    "    </table>" +
                    "    <br>" +
                    "    <span id='studentTotal' style='font-size: 18px'></span>" +
                    "<br> <div id='resultDiaryForm'></div>"

                document.getElementById("result").innerHTML = result;
                document.getElementById("studentTotal").innerText = "Tổng số lượng học viên: " + studentTotal;

            }
        })
    }


    function showDiaryForm(id, typeDiary) {
        event.preventDefault()
        document.getElementById("success").innerHTML = "";
        if (typeDiary === 'classDiary') {
            document.getElementById("resultDiaryForm").innerHTML =
                `<div>
                    <form>
                        <div class="form-floating">
                              <textarea class="form-control" placeholder="Leave a comment here"
                              id="content" style="height: 180px;width: 400px">
                              </textarea>
                          </div>
                        <button class="btn btn-primary" onclick="addNewDiary(${id},'classDiary')">Save diary</button>
                        <button class="btn btn-danger" onclick="reloadPage()" >Cancel</button>
                    </form>
                </div>`
        } else {
            document.getElementById("resultStudentDiaryForm").innerHTML =
                `<div>
                    <form>
                          <div class="form-floating">
                              <textarea class="form-control" placeholder="Leave a comment here"
                              id="content" style="height: 180px;width: 400px">
                              </textarea>
                          </div>
                          <button class="btn btn-primary" onclick="addNewDiary(${id},'studentDiary')">Save diary</button>
                          <button class="btn btn-danger" onclick="showStudentDetail(${id})">Cancel</button>
                    </form>
                </div>`
        }

    }


    function addNewDiary(id, typeDiary) {
        event.preventDefault();
        let content = $('#content').val();
        let date = new Date();
        let coachName = window.sessionStorage.getItem('NAME_KEY');
        let diary = {};

        if (typeDiary === 'classDiary') {
            diary = {
                content: content,
                date: date,
                coachName: coachName,
                classesId: id
            }
        } else {
            diary = {
                content: content,
                date: date,
                coachName: coachName,
                usersId: id
            }
        }

        let success = {message: "Create success!"}
        $.ajax({
            contentType: 'application/json; charset=utf8',
            url: 'http://localhost:8080/diary/create',
            method: 'POST',
            data: JSON.stringify(diary),
            success: function (data) {
                if (JSON.stringify(data) === JSON.stringify(success)) {
                    if (typeDiary === 'classDiary') {
                        showListClasses()
                        document.getElementById("success").innerHTML = "Đã lưu vào nhật ký của ngày hôm nay!";
                    } else {
                        showStudentDetail();
                        document.getElementById("resultStudentDiaryForm").innerHTML = ""
                        document.getElementById("success").innerHTML = "Đã lưu vào nhật ký của ngày hôm nay!";
                    }

                }
            }
        })

    }


    function showListStudentByClassId(id) {
        event.preventDefault()
        window.sessionStorage.setItem('CLASSES_ID', id);
        let url = ('http://localhost:8080/user/findAllStudentByClassesId/' + id);
        $.ajax({
            url: url,
            type: "GET",
            success: function (data) {
                let size = data.length;
                showPageListStudent(url, size)
            }
        })
    }


    function showPageListStudent(url, size) {
        $(function () {
            let container = $('#result2');
            container.pagination({
                dataSource: url,
                locator: 'itemts',
                totalNumber: size,
                pageSize: 3,
                callback: function (response, pagination) {
                    let result =
                        '<div><a href="" onclick="reloadPage()">Quay lại danh sách lớp</a></div> <br>' +
                        '<div>\n' +
                        '    <label for="status">Chọn trạng thái hiển thị:</label>\n' +
                        '    <select class="form-select" aria-label="Default select example"' +
                        'onchange="showPageListStudentByStatus(window.sessionStorage.getItem(`CLASSES_ID`))" id="status">\n' +
                        '        <option>----</option>\n' +
                        '        <option value="all">Tất cả</option>\n' +
                        '        <option value="Đang học">Đang học</option>\n' +
                        '        <option value="Đình chỉ">Đình chỉ</option>\n' +
                        '        <option value="Chờ chuyển lớp">Chờ chuyển lớp</option>\n' +
                        '        <option value="Thôi học">Thôi học</option>\n' +
                        '    </select>\n' +
                        '</div>' +
                        '<table width="50%" class="table">\n' +
                        '        <tbody>';
                    let pageStart = (pagination.pageNumber - 1) * pagination.pageSize;
                    let pageEnd = pageStart + pagination.pageSize;
                    let pageItems = response.slice(pageStart, pageEnd);
                    $.each(pageItems, function (index, item) {
                        let indexs = index + 1;
                        result +=
                            `<tr>
                                <td>${indexs}
                                <br>
                                <img src="${item.avatar}" alt="" width="120" height="120"><br>
                                <a href="" onclick="showStudentDetail(${item.id})">${item.fullName}</a>
                                </td>
                            </tr>`
                    })
                    result += "  </tbody>\n" +
                        "    </table>"
                    container.prev().html(result);

                }
            })
        })
    }


    function showStudentDetail(id) {
        event.preventDefault()
        $.ajax({
            url: 'http://localhost:8080/user/findById/' + id,
            type: "GET",
            success: function (data) {
                document.getElementById("result").innerHTML =
                    `
<div>
<a href="" onclick="showListStudentByClassId(${window.sessionStorage.getItem('CLASSES_ID')})">Quay lại danh sách học sinh</a>
<br>
    <fieldset style="width: 50%">
        <legend>Information:</legend>
        <table class="table">
            <tr>
                <td></td>
                <td>
                 <img src="${data.avatar}"
                     alt="" width="330" height="250">
                </td>
            </tr>
            <tr>
                <td></td>
                <td>
                    Họ tên:<strong>${data.fullName}</strong>
                </td>
            </tr>
            <tr>
                <td></td>
                <td>Email: <strong>${data.email}</strong></td>
            </tr>
            <tr>
                <td></td>
                <td>Phone number: <strong>${data.phoneNumber}</strong></td>
            </tr>
            <tr>
                <td></td>
                <td>Address:<strong>${data.address}</strong></td>
            </tr>
            <tr>
                <td></td>
                <td>Status: <strong>${data.status}</strong></td>
            </tr>
            <tr>
                <td></td>
                <td><a href="" onclick="showDiaryForm(${data.id},'studentDiary')">Viết nhật ký cho ${data.fullName}</a></td>
            </tr>
        </table>
        <div id='resultStudentDiaryForm'></div>
    </fieldset>
</div>
--------------------------------------------

                `

            }
        })
    }


    function showPageListStudentByStatus(id) {
        let status = $('#status').val()
        let url = ('http://localhost:8080/user/findAllStudentByClassesId/' + id + '?status=' + status);
        $.ajax({
            url: url,
            type: "GET",
            success: function (data) {
                let size = data.length;
                showPageListStudent(url, size)
            }
        })
    }

    function reloadPage() {
        location.reload();
    }


    function logOut() {
        event.preventDefault()
        logOutConfirm()
    }</script>
</html>